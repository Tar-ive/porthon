<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Porthon — Your Agent</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-hover: #1a1a1a;
            --border: #2a2a2a;
            --text: #e5e5e5;
            --text-dim: #888;
            --accent: #6366f1;
            --accent-dim: #4f46e5;
            --user-bg: #1e1b4b;
            --agent-bg: #141414;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header .dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #22c55e;
        }
        .header .dot.offline { background: #ef4444; }
        .header h1 { font-size: 16px; font-weight: 600; }
        .header .status { font-size: 12px; color: var(--text-dim); margin-left: auto; }

        /* Chat area */
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 720px;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message.user {
            background: var(--user-bg);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .message.agent {
            background: var(--agent-bg);
            border: 1px solid var(--border);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message.agent .intent-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 8px;
            background: var(--accent-dim);
            color: white;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        .message strong { color: #a5b4fc; }
        .message code {
            background: #1e1e2e;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Typing indicator */
        .typing {
            display: none;
            align-self: flex-start;
            padding: 12px 16px;
            color: var(--text-dim);
            font-size: 13px;
        }
        .typing.active { display: block; }
        .typing span {
            animation: blink 1.4s infinite;
        }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        /* Input area */
        .input-area {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        .input-area textarea {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 44px;
            max-height: 120px;
        }
        .input-area textarea:focus { border-color: var(--accent); }
        .input-area textarea::placeholder { color: var(--text-dim); }

        .input-area button {
            background: var(--accent);
            border: none;
            border-radius: 12px;
            padding: 0 20px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
        }
        .input-area button:hover { background: var(--accent-dim); }
        .input-area button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Welcome */
        .welcome {
            text-align: center;
            padding: 80px 24px;
            color: var(--text-dim);
        }
        .welcome h2 { color: var(--text); margin-bottom: 8px; font-size: 20px; }
        .welcome p { font-size: 14px; max-width: 400px; margin: 0 auto; }

        /* Scrollbar */
        .chat::-webkit-scrollbar { width: 6px; }
        .chat::-webkit-scrollbar-track { background: transparent; }
        .chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="dot" id="statusDot"></div>
        <h1>Porthon Agent</h1>
        <div class="status" id="statusText">connecting...</div>
    </div>

    <div class="chat" id="chat">
        <div class="welcome" id="welcome">
            <h2>Hey, Theo.</h2>
            <p>Ask me anything — about your finances, patterns, goals, or just talk. I know you better than you think.</p>
        </div>
    </div>

    <div class="typing" id="typing">
        <span>●</span><span>●</span><span>●</span> thinking...
    </div>

    <div class="input-area">
        <textarea id="input" placeholder="Type a message..." rows="1"></textarea>
        <button id="send" onclick="sendMessage()">Send</button>
    </div>

    <script>
        const chatEl = document.getElementById('chat');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const typingEl = document.getElementById('typing');
        const welcomeEl = document.getElementById('welcome');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        let ws = null;
        let currentAgentMsg = null;
        let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);

        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/${sessionId}`);

            ws.onopen = () => {
                statusDot.classList.remove('offline');
                statusText.textContent = 'online';
            };

            ws.onclose = () => {
                statusDot.classList.add('offline');
                statusText.textContent = 'reconnecting...';
                setTimeout(connect, 3000);
            };

            ws.onerror = () => {
                statusDot.classList.add('offline');
                statusText.textContent = 'connection error';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'meta') {
                    // Start a new agent message
                    typingEl.classList.remove('active');
                    currentAgentMsg = addMessage('', 'agent', data.intent);
                }
                else if (data.type === 'token') {
                    if (currentAgentMsg) {
                        // Append token to current message
                        const contentEl = currentAgentMsg.querySelector('.content');
                        contentEl.textContent += data.content;
                        scrollToBottom();
                    }
                }
                else if (data.type === 'done') {
                    currentAgentMsg = null;
                    sendBtn.disabled = false;
                    inputEl.disabled = false;
                    inputEl.focus();
                }
            };
        }

        function addMessage(text, role, intent = null) {
            if (welcomeEl) welcomeEl.style.display = 'none';

            const msg = document.createElement('div');
            msg.className = `message ${role}`;

            let html = '';
            if (role === 'agent' && intent && intent !== 'casual') {
                html += `<div class="intent-badge">${intent}</div>`;
            }
            html += `<div class="content">${text}</div>`;
            msg.innerHTML = html;

            chatEl.appendChild(msg);
            scrollToBottom();
            return msg;
        }

        function scrollToBottom() {
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function sendMessage() {
            const text = inputEl.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

            addMessage(text, 'user');
            ws.send(JSON.stringify({ message: text }));

            inputEl.value = '';
            inputEl.style.height = 'auto';
            sendBtn.disabled = true;
            inputEl.disabled = true;
            typingEl.classList.add('active');
        }

        // Auto-resize textarea
        inputEl.addEventListener('input', () => {
            inputEl.style.height = 'auto';
            inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
        });

        // Enter to send, Shift+Enter for newline
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Connect on load
        connect();
    </script>
</body>
</html>
